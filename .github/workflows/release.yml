name: Release

on:
    push:
        tags:
            - "*.*.*"

permissions:
    contents: write

jobs:
    release:
        runs-on: macos-14

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Swift
              uses: swift-actions/setup-swift@v2
              with:
                  swift-version: "6.2"

            - name: Build release binary
              run: swift build -c release --product xcode-bsp

            - name: Package artifacts
              run: |
                  set -euo pipefail

                  tag="${GITHUB_REF_NAME}"
                  bin_dir="$(swift build -c release --show-bin-path)"
                  archive_name="xcode-bsp-${tag}-macos.tar.gz"

                  mkdir -p dist
                  cp "${bin_dir}/xcode-bsp" dist/xcode-bsp
                  chmod +x dist/xcode-bsp

                  tar -C dist -czf "dist/${archive_name}" xcode-bsp
                  shasum -a 256 "dist/${archive_name}" > "dist/${archive_name}.sha256"
                  rm dist/xcode-bsp

            - name: Publish GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  files: |
                      dist/*.tar.gz
                      dist/*.sha256
                  generate_release_notes: true
